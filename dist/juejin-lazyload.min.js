/**
 * juejin-lazyload v0.1.2
 * (c) 2017 WEBuster <webuster@xitu.io>
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.JuejinLazyload=t()}(this,function(){"use strict";function e(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return e.addEventListener(t,n,i),function(){e.removeEventListener(t,n,i)}}!function(){function e(e){this.value=e}function t(t){function n(o,r){try{var a=t[o](r),s=a.value;s instanceof e?Promise.resolve(s.value).then(function(e){n("next",e)},function(e){n("throw",e)}):i(a.done?"return":"normal",a.value)}catch(e){i("throw",e)}}function i(e,t){switch(e){case"return":o.resolve({value:t,done:!0});break;case"throw":o.reject(t);break;default:o.resolve({value:t,done:!1})}(o=o.next)?n(o.key,o.arg):r=null}var o,r;this._invoke=function(e,t){return new Promise(function(i,a){var s={key:e,arg:t,resolve:i,reject:a,next:null};r?r=r.next=s:(o=r=s,n(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}();var t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},o={threshold:0,interval:200,debounce:!1,reactive:!0,infoGetter:null,visibleAreaGetter:null,onStateChange:null};return function(){function r(e,n){t(this,r),this.setOptions(n),this.addOrUpdateElement(e),this.initEventListener()}return n(r,[{key:"setOptions",value:function(e){this.options=i({},o,e)}},{key:"initEventListener",value:function(){var t=this;if(this.options.reactive){var n=this.options.debounce?function(e,t){var n=0;return function(){for(var i=this,o=arguments.length,r=Array(o),a=0;a<o;a++)r[a]=arguments[a];clearTimeout(n),n=setTimeout(function(){return e.apply(i,r)},t)}}(function(){return t.updateState()},this.options.interval):function(e,t){var n=0;return t/=2,function(){for(var i=arguments.length,o=Array(i),r=0;r<i;r++)o[r]=arguments[r];Date.now()-n>=t&&(n=Date.now(),setTimeout(function(){e.apply(null,o)},t))}}(function(){return t.updateState()},this.options.interval);this.removeScrollEventListener=e(window,"scroll",n),this.removeResizeEventListener=e(window,"resize",n)}}},{key:"removeEventListener",value:function(){this.removeScrollEventListener&&this.removeScrollEventListener(),this.removeResizeEventListener&&this.removeResizeEventListener()}},{key:"addOrUpdateElement",value:function(e){var t=this.getElementList(e),n=t.filter(function(e){return!e.__JUEJIN_LAZYLOAD});this.elementList=(this.elementList||[]).concat(n),t.forEach(this.initElement.bind(this)),this.updateState()}},{key:"removeElement",value:function(e){var t=this.getElementList(e);this.elementList=this.elementList.filter(function(e){return-1===t.indexOf(e)}),t.forEach(this.removeInfo.bind(this))}},{key:"clean",value:function(){this.elementList.forEach(this.removeInfo.bind(this)),this.elementList=[]}},{key:"getElementList",value:function(e){return e?"string"==typeof e?[].slice.call(document.querySelectorAll(e)):"number"==typeof e.length?[].slice.call(e):[e]:[]}},{key:"initElement",value:function(e){var t=this.options.infoGetter&&this.options.infoGetter(e),n=i({},t,{isImg:"IMG"===e.nodeName,loading:!1});n.hasPlaceholder=n.isImg&&n.width&&n.height,n.hasPlaceholder&&(e.src=function(e,t){return["data:image/svg+xml;utf8,",'<?xml version="1.0"?>','<svg xmlns="http://www.w3.org/2000/svg" version="1.1" ','width="'+e+'" height="'+t+'"',"></svg>"].join("")}(n.width,n.height)),e.__JUEJIN_LAZYLOAD=n,this.updateElementClassByState("inited",e)}},{key:"removeInfo",value:function(e){e.__JUEJIN_LAZYLOAD&&(e.__JUEJIN_LAZYLOAD=null)}},{key:"updateState",value:function(){var e=this;if(this.elementList.length){var t=this.getActiveArea();this.elementList.forEach(function(n){var i=n.__JUEJIN_LAZYLOAD.loading,o=n.getBoundingClientRect(),r=function(e,t){return!(t.bottom<e.top||t.top>e.bottom||t.right<e.left||t.left>e.right)}(t,o);!i&&r&&e.loadIamge(n)})}}},{key:"getActiveArea",value:function(){var e=this.getVisibleArea(),t=this.options.threshold||0;return{top:e.top-t,left:e.left-t,right:e.right+t,bottom:e.bottom+t}}},{key:"getVisibleArea",value:function(){if(this.options.visibleAreaGetter)return this.options.visibleAreaGetter();var e=function(){var e=document.documentElement;return{width:Math.max(e.clientWidth,window.innerWidth||0),height:Math.max(e.clientHeight,window.innerHeight||0)}}();return{top:0,left:0,right:e.width,bottom:e.height}}},{key:"loadIamge",value:function(e){var t=this,n=e.__JUEJIN_LAZYLOAD,i=n.url,o=n.isImg;n.loading=!0,this.updateElementClassByState("loading",e),this.invokeStateHook("loading",i,e),function(e,t,n){if(e){var i=new Image;i.onload=function(){t&&t(e)},i.onerror=function(){n&&n(e)},i.src=e}}(i,function(){o?e.src=i:e.style.backgroundImage="url("+i+")",t.removeElement(e),t.updateElementClassByState("loaded",e),t.invokeStateHook("loaded",i,e)},function(){t.removeElement(e),t.updateElementClassByState("error",e),t.invokeStateHook("error",i,e)})}},{key:"updateElementClassByState",value:function(e,t){switch(e){case"inited":t.classList.remove("loading"),t.classList.remove("loaded"),t.classList.remove("error");break;case"loading":t.classList.add("loading");break;case"loaded":t.classList.remove("loading"),t.classList.add("loaded");break;case"error":t.classList.remove("loading"),t.classList.add("error")}}},{key:"invokeStateHook",value:function(e,t,n){this.options.onStateChange&&this.options.onStateChange(e,t,n,this)}},{key:"destroy",value:function(){this.removeEventListener(),this.clean(),this.setOptions({})}}]),r}()});
